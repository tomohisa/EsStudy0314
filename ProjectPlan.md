# 基本の指示：

最初に ProjectPlan.md をまとめます。今回はイベントソーシングでアンケートアプリを作りたい。バックエンドは Sekiban+C#, フロントエンドはBlazorで。リアルタイムアンケートです。

プロジェクト名は、EsCQRSQuestions という名前で作成して下さい。

フロントエンドのページは /planning と /questionair の２ページですが、 /planning は、管理者だけが使うので、NavBarには表示しないでください。
/planning では、 質問の作成、統計を表示できます。

質問には、質問、回答選択肢を入力します。質問完成後に修正もでき、Start Display, Stop Display で回答者に表示します。

また、リアルタイムアンケートなので、質問には、"Start Display, Stop Display"があり 参加者 /questionair には、質問を Start Display すると、質問が表示され、Stop Displayすると質問が消えます。質問は同時に1つしか出ないので、Stopするとようこそ画面になります。
ようこそ画面、もしくは質問回答者画面では、回答者名を入力可能です。
誰かが回答すると、すべての人の回答が管理者画面 /Plan 画面に表示されます。

質問は常に、（選択オプション＋文字コメント）です。
例えば以下のような質問画面です。

あなたの名前 [ Johan Doe ] 名前も表示されます。空欄も可能です。
Q1: イベントソーシングを使ったことがありますか？
A1-1 - はい たくさんあります
A1-2 - はい、少しだけ
A1-3 - 調べたことはあります
A1-4 - いいえ
コメント [       ]
（回答する）ボタン

質問がStart Displayされたら回答者の画面にも他の人の回答が表示されます。

すべてイベントソーシングで行われますが、質問ごとに１集約となります。

SignalRでクライアントには、Startイベント、Stopイベント、他の人の回答イベントなどが配信されます。配信されたら該当する質問の集約を取得して、各クライアントが表示します。

SignalR のサンプルは
Sample/MessageEachOther/MessageEachOther.ApiService/Program.cs バックエンド
[フロントエンド](Sample/MessageEachOther/MessageEachOther.Web/Components/Pages/Weather.razor)
このサンプルに基づいて作って下さい。

# Clineによる詳細プラン

【概要】
- **プロジェクト名称**: EsCQRSQuestions
  - イベントソーシングを用いたリアルタイムアンケートアプリ。
- **バックエンド**: Sekiban + C# を使用し、CQRS パターンおよびイベントソーシングにより集約単位（各質問ごと）で状態管理。
- **フロントエンド**: Blazor を用いてシングルページアプリケーションとして実装。
- **リアルタイム機能**: SignalR により、管理者と参加者間で Start/Stop イベントや回答送信等のリアルタイムコミュニケーションを実現。

【主要機能】
1. **管理者用画面 (/planning)**
   - 質問作成と編集: 質問文、回答選択肢、（任意の）コメント入力。
   - 回答統計の表示: 各質問に対して送信された回答を集計しグラフ等で表示。
   - 質問の「Start Display／Stop Display」操作: 質問を参加者に表示開始・終了させる。なお、/planning ページはナビゲーションバーからは隠し、管理者限定とする。

2. **参加者用画面 (/questionair)**
   - ウェルカム画面: ストップ状態のときは、参加者が名前を入力可能な画面（名前入力後、参加者名として以降の回答に反映）。
   - 質問表示: 管理者が「Start Display」を押すと、対象の質問と選択肢、コメントフォームが表示される。回答フォームもあり、選択肢入力＋自由記述が可能。
   - 回答送信: 回答即送信し、SignalR 経由で管理者用画面に通知される。

3. **リアルタイム通信 (SignalR)**
   - 管理者が質問に対して「Start Display」や「Stop Display」を操作すると各クライアントにイベントが配信され、該当質問の状態更新が行われる。
   - 参加者の回答が送信されると、これも SignalR 経由で管理者画面に反映（リアルタイム統計表示）。
   - サンプルコードとして既存の [Sample/MessageEachOther] にあるバックエンド (MessageEachOther.ApiService/Program.cs) およびフロントエンド (MessageEachOther.Web/Components/Pages/Weather.razor) を参照して設計する。

【技術アーキテクチャ】
- **バックエンド設計**
  - CQRS とイベントソーシング: 各質問を1つの集約とし、質問作成、更新、表示開始/終了、回答受付などのイベントを記録・再生。
  - SignalR Hub の実装: 管理者と参加者間の各種通知イベントを処理。
  - Sekiban フレームワークの利用: DDD の集約・リポジトリパターンを採用し、イベントストアへの書き込みなどを行う。
  
- **フロントエンド設計**
  - Blazor コンポーネント: /planning ページと /questionair ページを分離。/planning は管理者専用の非表示項目で、認証機構（簡易なもの）を想定。
  - SignalR クライアントの実装: サーバーからのイベントを受信し、質問・回答のリアルタイム表示を実現。

【画面遷移とユーザーフロー】
- 管理者は /planning で質問の作成、修正、表示開始・終了を行う。各操作ごとにイベントを発行し、参加者画面へ即時反映。
- 参加者はまず名前入力を済ませ、回答画面に移行。質問が Start されると質問内容が表示され、回答を送信できる。
- 回答送信後、管理者画面では全参加者の回答が集計表示される。

【参考サンプルの活用】
- バックエンドでは [Sample/MessageEachOther.ApiService/Program.cs] を参考に、SignalR のセットアップと API サービスロジックを構築。
- フロントエンドでは [Sample/MessageEachOther.Web/Components/Pages/Weather.razor] のコードを元に、Blazor コンポーネントとして SignalR クライアントを組み込み、画面表示を作成。

【今後のタスク】
1. バックエンドのイベントソーシング集約設計（質問作成、更新、表示操作、回答イベントの定義）。
2. SignalR Hub の実装、及びサンプルコードとの整合性確認。
3. /planning と /questionair の Blazor コンポーネント設計、各画面のUI・UXの詳細設計。
4. 管理者認証の簡易実装（/planning はナビバーから非表示）。
5. リアルタイム統計とデータ集計機能の設計。
6. インテグレーションテストおよび UI テストの準備。

【開発手法と技術実装詳細】

本プロジェクトの開発にあたっては、以下のドキュメントを参照して実装を進めます：

1. **Sekiban イベントソーシング実装ガイド**: `cline_docs/Sekiban.Instructions.md`
   - Sekiban フレームワークの基本概念と実装パターン
   - 集約、イベント、コマンド、プロジェクターの実装方法
   - API エンドポイントの設定方法
   - テスト手法

2. **プロジェクト構造とコーディング規約**: `cline_docs/.clinerules`
   - クリーンアーキテクチャに基づくプロジェクト構造
   - イベントソーシングを中心とした永続化メカニズム
   - Blazor コンポーネントベースのフロントエンド設計

3. **SignalR 実装参考**: `Sample/MessageEachOther/` ディレクトリ内のサンプルコード
   - バックエンド: `MessageEachOther.ApiService/Program.cs`
   - フロントエンド: `MessageEachOther.Web/Components/Pages/Weather.razor`

これらのドキュメントとサンプルコードに基づき、Sekiban フレームワークの特性を活かしたイベントソーシングアーキテクチャを実装します。開発は Sekiban テンプレートを使用して始め、CQRS パターンに従ってドメインモデルを設計します。
