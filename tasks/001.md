# Task 001: UI Update Issues in EsCQRSQuestions

## Issues Addressed

### 1. Questionair.razor Issues
- Comment section was showing regardless of whether a question option was selected
- Page needed to show "Waiting to show question" when no option was selected
- Page wasn't updating when other users answered questions

### 2. Planning.razor Issues
- Page wasn't redrawing when a question was added

## Approach

### Questionair.razor Fixes

1. **Conditional Comment Display**
   - Modified the comment section to only show when a question option is selected
   - Added an info alert with "Waiting to show question" message when no option is selected
   - Used conditional rendering with `@if (!string.IsNullOrEmpty(selectedOptionId))` to control visibility

2. **Real-time Updates for Other Users' Responses**
   - Modified the ResponseAdded event handler to always refresh the active question, regardless of showResponses flag
   - Added explicit StateHasChanged() calls to ensure UI updates
   - Enhanced the RefreshActiveQuestion method with better error handling and logging
   - Changed the condition for displaying responses to show them to all users, not just those who submitted a response

### Planning.razor Fixes

1. **UI Redraw for Question Addition**
   - Enhanced the RefreshQuestions method with try-catch and detailed logging
   - Changed StateHasChanged() calls to use lambda expressions with InvokeAsync to ensure execution on the UI thread
   - Added manual calls to RefreshQuestions() after key operations (create, update, delete, start/stop display)
   - Added console logging throughout to help diagnose issues

## Implementation Details

### Questionair.razor Changes

```csharp
// Before: Comment section always visible
<div class="mb-4">
    <label for="comment" class="form-label">Comment (optional)</label>
    <textarea class="form-control" id="comment" rows="3" 
              @bind="comment" placeholder="Add your comment here"></textarea>
</div>

// After: Conditional display based on selection
<div class="mb-4">
    @if (!string.IsNullOrEmpty(selectedOptionId))
    {
        <label for="comment" class="form-label">Comment (optional)</label>
        <textarea class="form-control" id="comment" rows="3" 
                  @bind="comment" placeholder="Add your comment here"></textarea>
    }
    else
    {
        <div class="alert alert-info">
            Waiting to show question
        </div>
    }
</div>
```

```csharp
// Before: Only refreshed for users who had submitted responses
hubConnection.On<object>("ResponseAdded", async _ =>
{
    if (activeQuestion != null && showResponses)
    {
        await RefreshActiveQuestion();
    }
});

// After: Refreshes for all users
hubConnection.On<object>("ResponseAdded", async _ =>
{
    if (activeQuestion != null)
    {
        Console.WriteLine("Response added event received");
        await RefreshActiveQuestion();
        await InvokeAsync(() => StateHasChanged());
        Console.WriteLine("Question refreshed after response added");
    }
});
```

```csharp
// Before: Only showed responses to users who had submitted
@if (showResponses && activeQuestion.Responses.Any())

// After: Shows responses to all users
@if (activeQuestion.Responses.Any())
```

### Planning.razor Changes

```csharp
// Before: Basic refresh without error handling
private async Task RefreshQuestions()
{
    questions = (await QuestionApi.GetQuestionsAsync()).ToList();
    await InvokeAsync(StateHasChanged);
}

// After: Enhanced refresh with error handling and logging
private async Task RefreshQuestions()
{
    try
    {
        Console.WriteLine("Refreshing questions...");
        var fetchedQuestions = await QuestionApi.GetQuestionsAsync();
        questions = fetchedQuestions.ToList();
        Console.WriteLine($"Fetched {questions.Count} questions");
        await InvokeAsync(() => StateHasChanged());
        Console.WriteLine("State has changed");
    }
    catch (Exception ex)
    {
        Console.Error.WriteLine($"Error refreshing questions: {ex.Message}");
    }
}
```

```csharp
// Added manual refresh after saving a question
private async Task SaveQuestion()
{
    // ... existing validation and saving logic ...
    
    try
    {
        // ... existing code ...
        
        await CloseModal();
        
        // Manually refresh questions after saving
        await RefreshQuestions();
    }
    catch (Exception ex)
    {
        Console.Error.WriteLine($"Error saving question: {ex.Message}");
    }
}
```

## Results

The implemented changes successfully addressed all the identified issues:

1. The comment section in Questionair.razor now only appears when a question option is selected
2. "Waiting to show question" is displayed when no option is selected
3. The Planning.razor page now properly redraws when questions are added
4. The Questionair.razor page now updates when other users answer questions
5. All users can now see response statistics in real-time

These improvements enhance the real-time collaborative experience for both administrators and participants.
